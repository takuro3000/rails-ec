# 要件定義書（Requirements Specification）

## 1. プロジェクト概要

### 1.1 プロジェクト名
Rails EC - シンプルECサイト

### 1.2 目的
シンプルで拡張性の高いECサイトのMVP（最小機能製品）を構築する。

### 1.3 スコープ

#### MVP対象機能
- ユーザー認証（会員登録・ログイン）
- 配送先住所管理
- 商品一覧・詳細・検索
- カート機能
- 注文作成・履歴管理
- Stripe決済連携
- 管理者機能（商品・注文管理）

#### 将来拡張予定（MVP対象外）
- お気に入り機能
- レビュー・評価機能
- クーポン・割引機能
- 複数配送先への分割配送
- 在庫アラート通知
- 売上レポート・分析

---

## 2. ユーザーロール定義

### 2.1 ゲストユーザー
- 会員登録なしでサイトを閲覧可能
- 商品一覧・詳細の閲覧
- 商品検索・カテゴリ絞り込み
- カートへの商品追加（セッションベース）
- 購入には会員登録が必要

### 2.2 会員ユーザー（Customer）
- ゲストユーザーの全機能
- ログイン・ログアウト
- 配送先住所の管理
- カート情報のDB永続化
- 注文の作成・決済
- 注文履歴の確認

### 2.3 管理者（Admin）
- 管理画面へのアクセス
- 商品のCRUD操作
- カテゴリ管理
- 注文一覧・詳細確認
- 注文ステータスの更新

---

## 3. 機能要件

### 3.1 認証/ユーザー管理

#### 3.1.1 会員登録
**ユーザーストーリー**
> 新規ユーザーとして、メールアドレスとパスワードで会員登録し、ECサイトで買い物ができるようになりたい。

**フロー**
1. 会員登録フォームにアクセス
2. 必要情報を入力（名前、メールアドレス、パスワード）
3. バリデーション通過後、アカウント作成
4. 自動ログインしてトップページへリダイレクト

**バリデーションルール**
| フィールド | ルール |
|-----------|--------|
| name | 必須、2〜50文字 |
| email | 必須、有効なメール形式、一意 |
| password | 必須、8文字以上 |
| password_confirmation | passwordと一致 |

**備考**
- MVP段階ではメール確認は実装しない（将来拡張）

#### 3.1.2 ログイン/ログアウト
**ユーザーストーリー**
> 登録済みユーザーとして、メールアドレスとパスワードでログインし、自分のアカウントにアクセスしたい。

**フロー（ログイン）**
1. ログインフォームにアクセス
2. メールアドレスとパスワードを入力
3. 認証成功後、元のページまたはトップページへリダイレクト
4. セッションにカート情報があれば、DBのカートとマージ

**フロー（ログアウト）**
1. ログアウトボタンをクリック
2. セッションを破棄
3. トップページへリダイレクト

#### 3.1.3 パスワードリセット
**ユーザーストーリー**
> パスワードを忘れたユーザーとして、メールアドレスを使ってパスワードをリセットしたい。

**フロー**
1. パスワードリセットフォームにアクセス
2. 登録済みメールアドレスを入力
3. リセット用リンクをメール送信
4. リンクから新しいパスワードを設定
5. ログインページへリダイレクト

#### 3.1.4 配送先住所管理
**ユーザーストーリー**
> 会員ユーザーとして、複数の配送先住所を登録・管理し、注文時に選択できるようにしたい。

**機能**
- 住所の追加（最大5件）
- 住所の編集
- 住所の削除
- デフォルト住所の設定

**住所フィールド**
| フィールド | ルール |
|-----------|--------|
| postal_code | 必須、7桁の数字 |
| prefecture | 必須、都道府県選択 |
| city | 必須、市区町村 |
| address_line1 | 必須、番地 |
| address_line2 | 任意、建物名・部屋番号 |
| recipient_name | 必須、届け先氏名 |
| phone_number | 必須、電話番号 |
| is_default | デフォルト住所フラグ |

---

### 3.2 商品管理

#### 3.2.1 商品一覧表示
**ユーザーストーリー**
> ユーザーとして、商品一覧を見て興味のある商品を探したい。

**機能**
- 商品一覧のページネーション（1ページ12件）
- ソート機能
  - 新着順（デフォルト）
  - 価格の安い順
  - 価格の高い順
- グリッド表示（レスポンシブ対応）

**表示項目**
- 商品画像（サムネイル）
- 商品名
- 価格（税込）
- 在庫状況（在庫あり/残りわずか/在庫切れ）

#### 3.2.2 商品詳細表示
**ユーザーストーリー**
> ユーザーとして、商品の詳細情報を確認してから購入を判断したい。

**表示項目**
- 商品画像（複数枚、ギャラリー表示）
- 商品名
- 価格（税込）
- 商品説明
- カテゴリ
- 在庫数
- カートに追加ボタン（数量選択付き）

**ビジネスロジック**
- 在庫切れの場合はカート追加ボタンを無効化
- 在庫数以上の数量は選択不可

#### 3.2.3 カテゴリによる絞り込み
**ユーザーストーリー**
> ユーザーとして、カテゴリで商品を絞り込んで探したい。

**機能**
- サイドバーまたはヘッダーにカテゴリ一覧を表示
- カテゴリクリックで該当商品のみ表示
- パンくずリストでの現在位置表示

#### 3.2.4 キーワード検索
**ユーザーストーリー**
> ユーザーとして、キーワードで商品を検索したい。

**機能**
- ヘッダーに検索フォームを配置
- 商品名・説明文を対象に部分一致検索
- 検索結果のページネーション対応

#### 3.2.5 在庫表示ロジック
| 在庫数 | 表示 |
|--------|------|
| 0 | 在庫切れ（赤色バッジ） |
| 1〜5 | 残りわずか（オレンジバッジ） |
| 6以上 | 在庫あり（緑色バッジ） |

#### 3.2.6 画像表示
- Active Storageを使用
- 商品につき複数画像をサポート（最大5枚）
- 最初の画像をメイン画像として使用
- サムネイル用にリサイズ（variant）

---

### 3.3 カート機能

#### 3.3.1 カートへの追加
**ユーザーストーリー**
> ユーザーとして、気になる商品をカートに追加して、後でまとめて購入したい。

**フロー**
1. 商品詳細ページで数量を選択
2. 「カートに追加」ボタンをクリック
3. 在庫チェック
4. カートに追加（同じ商品があれば数量を加算）
5. カートアイコンに数量バッジを更新（Turbo Stream）
6. 追加完了メッセージを表示

**ビジネスロジック**
- 在庫数を超える追加は不可
- 既にカートにある商品は数量を加算
- ゲストはセッション、会員はDBに保存

#### 3.3.2 数量変更
**ユーザーストーリー**
> ユーザーとして、カート内の商品数量を変更したい。

**機能**
- 数量増減ボタン（+/-）
- 直接入力フィールド
- 変更時に小計を即時更新（Turbo Frame）

**ビジネスロジック**
- 最小数量: 1
- 最大数量: 在庫数
- 0にすると削除確認ダイアログ

#### 3.3.3 商品削除
**ユーザーストーリー**
> ユーザーとして、不要な商品をカートから削除したい。

**機能**
- 削除ボタンをクリック
- 確認なしで即時削除（Turbo Streamで更新）
- 合計金額を再計算

#### 3.3.4 小計・合計表示
**表示項目**
- 各商品の小計（単価 × 数量）
- 商品合計
- 送料（MVP: 全国一律500円、または5,000円以上で無料）
- 合計金額

#### 3.3.5 永続化戦略
| ユーザー種別 | 保存先 | 詳細 |
|-------------|--------|------|
| ゲスト | セッション | session[:cart] にハッシュで保存 |
| 会員 | データベース | cart_itemsテーブルに保存 |

**ログイン時のマージ処理**
1. セッションにカート情報があるか確認
2. DBのカートと比較
3. 同じ商品は数量を加算（在庫上限を超えない）
4. 新しい商品は追加
5. セッションのカート情報をクリア

---

### 3.4 注文機能

#### 3.4.1 注文作成フロー
**ユーザーストーリー**
> 会員ユーザーとして、カートの商品を注文し、決済を完了したい。

**フロー**
1. カートページで「注文手続きへ」をクリック
2. 配送先住所を選択（または新規入力）
3. 注文内容確認画面を表示
4. 「決済へ進む」でStripe Checkoutへリダイレクト
5. 決済完了後、注文確定
6. 注文完了ページを表示
7. 注文確認メールを送信

**注文作成時のビジネスロジック**
- 在庫の最終確認
- 在庫不足の場合はエラー表示
- 注文レコード作成（ステータス: pending）
- 注文明細レコード作成
- カートをクリア

#### 3.4.2 注文ステータス管理
| ステータス | 説明 | 遷移条件 |
|-----------|------|----------|
| pending | 未決済 | 注文作成時の初期状態 |
| paid | 決済済 | Stripe Webhook受信時 |
| cancelled | キャンセル | 決済失敗、または手動キャンセル |

**ステータス遷移図**
```
[pending] --決済成功--> [paid]
[pending] --決済失敗--> [cancelled]
[pending] --期限切れ--> [cancelled]
[paid] --管理者操作--> [cancelled] (返金処理が必要)
```

#### 3.4.3 注文履歴表示
**ユーザーストーリー**
> 会員ユーザーとして、過去の注文履歴を確認したい。

**機能**
- 注文一覧（新しい順）
- ページネーション（1ページ10件）

**表示項目**
- 注文番号
- 注文日時
- 合計金額
- ステータス
- 詳細リンク

#### 3.4.4 注文詳細表示
**表示項目**
- 注文番号
- 注文日時
- ステータス
- 配送先住所
- 注文商品一覧（商品名、数量、単価、小計）
- 商品合計
- 送料
- 合計金額
- 決済情報（決済方法、決済日時）

---

### 3.5 決済機能

#### 3.5.1 Stripe連携
**使用機能**
- Stripe Checkout Session（リダイレクト型）
- Stripe Webhooks

**選択理由**
- PCI DSSコンプライアンス対応が容易
- カード情報を自社サーバーで扱わない
- 多様な決済手段に対応可能

#### 3.5.2 Checkout Session作成
**フロー**
1. 注文確認画面で「決済へ進む」をクリック
2. サーバーサイドでStripe Checkout Session作成
   - line_items: 注文商品
   - success_url: 決済成功時のリダイレクトURL
   - cancel_url: 決済キャンセル時のリダイレクトURL
   - metadata: order_id
3. Stripe Checkoutページへリダイレクト

#### 3.5.3 Webhook処理
**対応イベント**
| イベント | 処理内容 |
|----------|----------|
| checkout.session.completed | 注文ステータスをpaidに更新、在庫減算 |
| checkout.session.expired | 注文ステータスをcancelledに更新 |

**Webhook検証**
- Stripe署名の検証必須
- リプレイ攻撃対策

#### 3.5.4 決済結果の反映
**決済成功時**
1. 注文ステータスをpaidに更新
2. 在庫数を減算
3. 決済情報を保存（stripe_payment_intent_id等）
4. 注文確認メールを送信

**決済失敗/キャンセル時**
1. 注文ステータスをcancelledに更新
2. カートの内容を復元（任意）

#### 3.5.5 通知
**メール通知**
- 注文確認メール（決済完了時）
  - 宛先: 注文者
  - 内容: 注文番号、注文内容、配送先、合計金額

---

### 3.6 管理者機能

#### 3.6.1 管理者認証
**ユーザーストーリー**
> 管理者として、専用のログインページから管理画面にアクセスしたい。

**機能**
- 管理者専用ログインページ（/admin/sign_in）
- 顧客とは別のセッション管理
- 管理画面へのアクセス制御

**備考**
- AdminUserテーブルで管理者を管理
- 初期管理者はseedsで作成

#### 3.6.2 商品CRUD
**一覧画面**
- 商品一覧表示（ページネーション）
- 検索・フィルタ機能
- 新規作成ボタン

**作成/編集画面**
| フィールド | ルール |
|-----------|--------|
| name | 必須、1〜100文字 |
| description | 任意、テキストエリア |
| price | 必須、1以上の整数 |
| stock | 必須、0以上の整数 |
| category_id | 必須、選択 |
| images | 任意、複数選択可（最大5枚） |
| is_published | 公開/非公開フラグ |

**削除**
- 論理削除を推奨（注文履歴との整合性のため）
- または削除時に注文明細との関連をチェック

#### 3.6.3 注文一覧・詳細
**一覧画面**
- 注文一覧（新しい順）
- ステータスでのフィルタ
- 検索（注文番号、顧客名、メールアドレス）

**詳細画面**
- 注文情報（顧客注文詳細と同様）
- ステータス更新フォーム

#### 3.6.4 注文ステータス更新
**更新可能なステータス遷移**
- pending → paid（手動決済確認時）
- pending → cancelled（キャンセル処理）
- paid → cancelled（返金処理時）

**更新時の処理**
- cancelledへの変更時: 在庫を戻す
- paidからcancelledへの変更時: Stripe返金APIを呼び出し（将来実装）

---

## 4. 非機能要件

### 4.1 セキュリティ要件
- CSRF対策（Rails標準）
- SQLインジェクション対策（ActiveRecord）
- XSS対策（ERBのエスケープ）
- 認証・認可の適切な実装
- Stripe Webhook署名検証
- 管理画面へのアクセス制限
- パスワードのハッシュ化（bcrypt）
- HTTPS必須（本番環境）

### 4.2 パフォーマンス要件
- ページロード: 3秒以内
- 適切なインデックス設計
- N+1クエリの防止
- 画像の最適化（リサイズ、WebP対応）
- ページネーションによる大量データ対策

### 4.3 アクセシビリティ
- セマンティックなHTML構造
- 適切なalt属性
- キーボード操作対応
- 十分なカラーコントラスト
- フォームのラベル付け

### 4.4 レスポンシブ対応
- モバイルファースト設計
- ブレークポイント
  - モバイル: 〜639px
  - タブレット: 640px〜1023px
  - デスクトップ: 1024px〜

---

## 5. 用語集

| 用語 | 説明 |
|------|------|
| MVP | Minimum Viable Product（最小機能製品） |
| SKU | Stock Keeping Unit（在庫管理単位） |
| カート | 購入予定商品の一時保存場所 |
| Checkout | 決済手続き |
| Webhook | 外部サービスからのイベント通知 |
